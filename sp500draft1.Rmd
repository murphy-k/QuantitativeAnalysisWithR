---
title: "Log-Returns Analysis & Simulation"
author: "Kyle Evan Murphy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
code_folding: hide
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Packages, message=FALSE, warning=FALSE, include=FALSE}
library(quantmod)   # get stock prices, stock analysis functions
library(xts)        # extensible time series functions
library(rvest)      # web scraping
library(tidyverse)  # ggplot2, purrr, dplyr, tidyr, readr, tibble
library(stringr)    # working with strings
library(forcats)    # working with factors
library(lubridate)  # working with dates in tibble / data frames
library(plotly)     # interactive plots
library(corrplot)   # visualizing correlation plots
```

### Overview

We'll use the SPDR S&P500 ETF "SPXS" as our proxy for SP500 returns due to it's high liquidity and consistently low tracking error. 20 years of price history will be downloaded but only 2018 is show in the chart below.
```{r SPXS Download, echo=FALSE, message=FALSE, warning=FALSE}
getSymbols(
  "SPXS",
  src = "yahoo",
  auto.assign = TRUE,
  from = Sys.Date() - 7306,
  to = Sys.Date(
  )
)
SPXS %>%
  chartSeries(TA = "addSMA(200);
              addVo();",
              subset = "2018::",
              theme = "white")
```


Next, we'll calculate the log returns of 'SPXS' Below are the 5 most recent observations.
```{r Calculate Log Returns, echo=FALSE}
SPXS %>%
  Ad() %>%
  dailyReturn(type = "log") %>%
  tail(n = 5)
```


Let's visualize the returns as a histogram. 
```{r Histogram, include=FALSE}
log_returns <- SPXS %>%
  Ad() %>%
  dailyReturn(type = "log")
names(log_returns) <- "Log.Returns"
```
```{r echo=FALSE}
(log_returns * 100) %>%
  ggplot(aes(x = Log.Returns)) +
  geom_histogram(bins = 100) +
  geom_density() +
  geom_rug(alpha = 0.5) + ggtitle("'SPXS' Log-% Returns ")
```

We can look at different quantiles of the distribution, followed by the mean and standard deviation of log returns.
```{r echo=FALSE, warning=FALSE}
probs <- c(.005, .025, .25, .5, .75, .975, .995)
dist_log_returns <- log_returns %>%
  quantile(probs = probs, na.rm = TRUE)
dist_log_returns
```


Displaying the mean and standard deviation values
```{r Moments, echo=FALSE}
mean_log_returns <- mean(log_returns, na.rm = TRUE)
sd_log_retuns <- sd(log_returns, na.rm = TRUE)
print(c("Mean log return:", mean_log_returns, "Std.Dev of log returns:", sd_log_retuns))
```

We will re-transfrom the log returns with exponentiation to get the actual return which is:
```{r Exponentiate, echo=FALSE}
mean_log_returns %>%
  exp()
```

Our average daily percent return is:
```{r Average Daily Percent Return, echo=FALSE}
(exp(mean_log_returns) - 1) * 100
```


```{r RW Simulation, include=FALSE}
N <- 1000
mu <- mean_log_returns
sigma <- sd_log_retuns
day <- 1:N
price_init <- SPXS$SPXS.Adjusted[[nrow(SPXS$SPXS.Adjusted)]]
SPXS$SPXS.Adjusted[[nrow(SPXS$SPXS.Adjusted)]]
# Simulate prices
set.seed(1)
price <- c(price_init, rep(NA, N - 1))
for (i in 2:N) {
  price[i] <- price [i - 1] * exp(rnorm(1, mu, sigma))
}
price_sim <- cbind(day, price) %>%
  as_tibble()
```

```{r RW Visual, echo=FALSE}
# Visualize the price simulation
price_sim %>%
  ggplot(aes(day, price)) +
  geom_line() +
  ggtitle(str_c("SPXS: Simulated Prices for ", N, " Trading Days"))
```


This particular simulation isn't useful itself - but we can generate many of these simulations in what is called a "Monte Carlo Analysis" Using the parameters below, we can simulate 252 trading days forward - 300 different times.
```{r Monte Carlo Parameters, echo=TRUE, message=FALSE, warning=FALSE}
N <- 252 # number of days to simulate
M <- 300 # number of monte carlo simulations
```



```{r Monte Carlo Code, echo=FALSE, warning=FALSE}
monte_carlo_matrix <- matrix(nrow = N, ncol = M)
for (j in 1:M) {
  monte_carlo_matrix[[1, j]] <- price_init
  for (i in 2:N) {
    monte_carlo_matrix[[i, j]] <-
      monte_carlo_matrix[[i - 1, j]] * exp(rnorm(1, mu, sigma))
  }
}
price_sim <- cbind(day, monte_carlo_matrix) %>%
  as_tibble()
nm <- str_c("Sim.", seq(1, M))
nm <- c("Day", nm)
names(price_sim) <- nm
price_sim <- price_sim %>%
  gather(key = "Simulation", value = "Stock.Price", -(Day))

# Visualize Simulation
price_sim %>%
  ggplot(aes(x = Day, y = Stock.Price, Group = Simulation)) +
  geom_line(alpha = 0.10) +
  ggtitle(str_c(
    "SPXS: ",
    M,
    " Monte Carlo Simulations for Prices Over ",
    N,
    " Trading Days"
  ))
```


The confidence intervals for our simulation:
```{r End Simulation Quartiles, echo=FALSE, message=FALSE, warning=FALSE}
end_stock_prices <- price_sim %>%
  filter(Day == max(Day))
dist_end_stock_prices <-
  quantile(end_stock_prices$Stock.Price, probs = probs)
dist_end_stock_prices %>% round(2)
```

The median value of these price simulations is:
```{r echo=FALSE}
print(dist_end_stock_prices[[4]])
```

Is this a realistic number? We can compare the CAGR for our entire dataset (20 years of SPXS data) and compare it to our simulation's CAGR.
```{r CAGR Calculations, include=FALSE}
N_hist <- nrow(SPXS) / 252
p_start_hist <- SPXS$SPXS.Adjusted[[1]]
p_end_hist <- SPXS$SPXS.Adjusted[[nrow(SPXS)]]
N_sim <- N / 252
p_start_sim <- p_end_hist
p_end_sim <- dist_end_stock_prices[[4]]
```


```{R CAGR Comparison, echo=FALSE}
CAGR_hist <- (p_end_hist / p_start_hist) ^ (1 / N_hist) - 1
CAGR_sim <- (p_end_sim / p_start_sim) ^ (1 / N_sim) - 1
print(c("SPXS CAGR %: ", round(CAGR_hist,4)*100))
print(c("Simulation CAGR %: ", round(CAGR_sim,digits = 4)*100))
```

### Conclusion
We calculated 20 years of logarithmic returns on the SP500 ETF "SPXS" and viewed them as a histogram. We determined the mean and the standard deviation of our empirical distribution and the average daily return percentage. (May not seem like a lot, but compounds daily.) We then constructed a "Random Walk" model given our SPXS's log return distributions moments (mean and variance). After simulating the random walk model several hundred times (Monte Carlo Simulation) and evaluating the confidence intervals - we finished by comparing the actual historical CAGR to our simulations hypothetical CAGR.  